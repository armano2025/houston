<!-- /lead.html
     דף "השארת פרטים": טופס RTL נגיש. שולח ל־Apps Script כ-text/plain, מעביר origin,
     לוכד UTM/referrer/UA, מציג הצלחה או "כבר קיבלנו" (dup), ומנתב ל-thanks בהצלחה. -->
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>יוסטון – השארת פרטים</title>
  <meta name="theme-color" content="#5b7cfa" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.light.css?v=2" />
</head>
<body>
  <main class="wrap">
    <section class="card">
      <header class="head">
        <div class="brand">
          <div class="logo" aria-hidden="true">HB</div>
          <div class="title">השארת פרטים</div>
          <p class="subtitle">ממלאים דקה – ונחזור בהקדם</p>
        </div>
      </header>

      <div class="body">
        <form id="leadForm" novalidate>
          <div class="row" style="gap:14px; flex-wrap:wrap">
            <div class="field" style="min-width:240px; flex:1">
              <label for="firstName">שם פרטי *</label>
              <input id="firstName" name="firstName" placeholder="לדוגמה: נועה" autocomplete="given-name" required autofocus />
            </div>
            <div class="field" style="min-width:240px; flex:1">
              <label for="lastName">שם משפחה</label>
              <input id="lastName" name="lastName" placeholder="אופציונלי" autocomplete="family-name" />
            </div>
          </div>

          <div class="row" style="gap:14px; flex-wrap:wrap">
            <div class="field" style="min-width:240px; flex:1">
              <label for="phone">טלפון *</label>
              <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel"
                     placeholder="05XXXXXXXX"
                     pattern="^0[0-9]{8,9}$"
                     title="מספר ישראלי: מתחיל ב־0 ואורך 9–10 ספרות"
                     required />
              <div class="meta">מספר ישראלי (0 + 9–10 ספרות). נקה אוטומטית תווים לא ספרתיים.</div>
            </div>

            <div class="field" style="min-width:240px; flex:1">
              <label for="subject">מקצוע *</label>
              <select id="subject" name="subject" required>
                <option value="" disabled selected>— בחרו —</option>
                <option>מתמטיקה</option>
                <option>אנגלית</option>
                <option>פיזיקה</option>
                <option>שפה</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="notes">מה חשוב שנדע?</label>
            <textarea id="notes" name="notes" rows="3" placeholder="למשל: ימים מועדפים, כיתה, רמת קושי"></textarea>
          </div>

          <!-- Honeypot: לא להסיר/לשנות את השם -->
          <input class="hp" name="website" tabindex="-1" autocomplete="off" />

          <div class="row" style="margin-top:8px">
            <button id="submitBtn" class="btn primary" type="submit" aria-label="שליחת הטופס">שלח</button>
            <span id="msg" class="status" role="status" aria-live="polite"></span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
  // קונפיג
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxRiJ_uMNpIJru-nNClAi787sA07hQSu7TX4cQEAm3_w3-dO2Hmp39ISxh81SqudA/exec';
  const ORIGIN   = location.origin;

  // לכידת utm/referrer/userAgent לתוך raw (לצד השרת)
  function collectContext(){
    const p = new URLSearchParams(location.search);
    const ctx = { referrer: document.referrer || '', userAgent: navigator.userAgent || '' };
    ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k => ctx[k] = p.get(k) || '');
    return ctx;
  }

  const form = document.getElementById('leadForm');
  const btn  = document.getElementById('submitBtn');
  const msg  = document.getElementById('msg');
  const phoneInput = document.getElementById('phone');

  // ניקוי תווים לא־ספרתיים בזמן הקלדה
  phoneInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^\d]/g, '');
  });

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();

    // טרימינג לשדות טקסט
    ['firstName','lastName','notes'].forEach(id => {
      const el = document.getElementById(id);
      if (el && typeof el.value === 'string') el.value = el.value.trim();
    });

    if (!form.reportValidity()) return;

    btn.disabled = true;
    const prevTxt = btn.textContent;
    btn.textContent = 'שולח…';
    msg.className = 'status';
    msg.textContent = 'שולח לשרת…';

    // הכנת נתונים
    const data = Object.fromEntries(new FormData(form).entries());
    data.context = collectContext(); // יישמר ב-raw
    const url = ENDPOINT + '?origin=' + encodeURIComponent(ORIGIN);

    try {
      // שולחים כ-text/plain כדי להימנע מ-preflight (Apps Script קורא זאת ב-parseBody_)
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'text/plain' },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      let j = {};
      try { j = JSON.parse(text); } catch(_) {}

      if (j && j.ok) {
        if (j.caseId === 'dup') {
          msg.className = 'status ok';
          msg.textContent = 'כבר קיבלנו את הפרטים לפני רגע – נחזור אליך בהקדם.';
        } else {
          // הצלחה: ניתוב לעמוד תודה
          location.assign('/thanks.html?caseId=' + encodeURIComponent(j.caseId));
          return;
        }
      } else {
        const err = (j && j.error) || (res.ok ? 'unknown' : ('HTTP ' + res.status));
        msg.className = 'status err';
        msg.textContent = 'שגיאה: ' + err;
      }
    } catch (e) {
      msg.className = 'status err';
      msg.textContent = 'שגיאת רשת. נסה שוב.';
    } finally {
      btn.disabled = false;
      btn.textContent = prevTxt;
    }
  });
  </script>
</body>
</html>